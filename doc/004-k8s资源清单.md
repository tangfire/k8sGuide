# ä»€ä¹ˆæ˜¯èµ„æº

èµ„æºå°±æ˜¯Kubernetesä¸­çš„ä¸€åˆ‡


## åŸºæœ¬æ¦‚è¿° - 1

![046](../img/img_46.png)


## åŸºæœ¬æ¦‚è¿° - 2

![047](../img/img_47.png)

## èµ„æºç±»åˆ«

![048](../img/img_48.png)


# èµ„æºæ¸…å•çš„ç¼–å†™(ç»“æ„ã€å®šä¹‰ã€ç¼–å†™)

## èµ„æºæ¸…å• - ç»“æ„ - apiVersion - 1

![049](../img/img_49.png)

![050](../img/img_50.png)

## èµ„æºæ¸…å• - ç»“æ„ - apiVersion - 2

![051](../img/img_51.png)

## èµ„æºæ¸…å• - ç»“æ„ - apiVersion - 3

![052](../img/img_52.png)

## èµ„æºæ¸…å• - å¯¹è±¡å±æ€§æŸ¥è¯¢

![053](../img/img_53.png)

## èµ„æºæ¸…å• - pod demo

![054](../img/img_54.png)

```shell
cd
mkdir 4
cd 4
vi 1.pod.yaml

```
å°†ä¸‹é¢è¿™ä¸ªç²˜è´´è¿›æˆ‘ä»¬çš„1.pod.yamlä¸­

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-demo
spec:
  containers:
    - name: myapp-1
      image: nginx:alpine  
    - name: busybox-1
      image: busybox:latest  
      command: ["/bin/sh", "-c", "sleep 3600"]
```

ç„¶åæ‰§è¡Œ: `kubectl create -f 1.pod.yaml`

ç­‰å¾…èµ„æºåˆ›å»ºæˆåŠŸ


å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯dockeræºçš„é—®é¢˜ï¼Œå¯ä»¥å»/etc/docker/daemon.jsonä¸­ï¼Œå°†è¿™ä¸ªæ–‡ä»¶é‡Œé¢æ”¹æˆå¦‚ä¸‹ï¼Œè®°å¾—æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ›´æ”¹

```json
{
    "registry-mirrors": [
    	"https://docker.m.daocloud.io",
    	"https://docker.imgdb.de",
    	"https://docker-0.unsee.tech",
    	"https://docker.hlmirror.com",
    	"https://docker.1ms.run",
    	"https://func.ink",
    	"https://lispy.org",
    	"https://docker.xiaogenban1993.com"
    ]
}


```

ç„¶åæ‰§è¡Œ: `sudo systemctl restart docker`

ç„¶ååˆ é™¤åˆšåˆšåˆ›å»ºå¤±è´¥çš„pod `kubectl delete pod pod-demo`

ç„¶åæ‰§è¡Œ:

```shell
kubectl create -f 1.pod.yaml
kubectl get pod 
```

é€šè¿‡`kubectl describe pod pod-demo`å¯ä»¥æŸ¥çœ‹èµ„æºåˆ›å»ºæƒ…å†µ

## kubectlå¸¸ç”¨å‘½ä»¤

doc/kubectl å¸¸ç”¨å‘½ä»¤.docx

### **Kubectl å¸¸ç”¨å‘½ä»¤æ•´ç†**

#### **1. æŸ¥çœ‹èµ„æº**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `kubectl get pod` | æŸ¥çœ‹å½“å‰å‘½åç©ºé—´çš„ Pod |
| `kubectl get pod -A` æˆ– `kubectl get pod --all-namespaces` | æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod |
| `kubectl get pod -n kube-system` | æŸ¥çœ‹ `kube-system` å‘½åç©ºé—´çš„ Pod |
| `kubectl get pod --show-labels` | æ˜¾ç¤º Pod çš„æ ‡ç­¾ |
| `kubectl get pod -l app=nginx` | ç­›é€‰ `app=nginx` çš„ Pod |
| `kubectl get pod -o wide` | æ˜¾ç¤º Pod çš„è¯¦ç»†ä¿¡æ¯ï¼ˆIPã€èŠ‚ç‚¹ç­‰ï¼‰ |
|`kubectl get pod -o yaml` |  è·å– Pod å®Œæ•´ YAML é…ç½®|
| `kubectl get pod -w` | å®æ—¶ç›‘æ§ Pod å˜åŒ– |

#### **2. è¿›å…¥ Pod æ‰§è¡Œå‘½ä»¤**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `kubectl exec -it podName -- /bin/sh` | è¿›å…¥ Pod é»˜è®¤å®¹å™¨ |
| `kubectl exec -it podName -c containerName -- /bin/bash` | è¿›å…¥æŒ‡å®šå®¹å™¨ |

#### **3. æŸ¥çœ‹èµ„æºæè¿°**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `kubectl explain pod.spec` | æŸ¥çœ‹ Pod çš„ `spec` å­—æ®µè¯´æ˜ |
| `kubectl describe pod podName` | æŸ¥çœ‹ Pod çš„è¯¦ç»†æè¿°ï¼ˆäº‹ä»¶ã€çŠ¶æ€ç­‰ï¼‰ |

#### **4. æŸ¥çœ‹æ—¥å¿—**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `kubectl logs podName` | æŸ¥çœ‹ Pod é»˜è®¤å®¹å™¨çš„æ—¥å¿— |
| `kubectl logs podName -c containerName` | æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„æ—¥å¿— |
| `kubectl logs -f podName` | å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆç±»ä¼¼ `tail -f`ï¼‰ |

#### **5. åˆ é™¤èµ„æº**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `kubectl delete pod podName` | åˆ é™¤æŒ‡å®š Pod |
| `kubectl delete pod --all` | åˆ é™¤å½“å‰å‘½åç©ºé—´çš„æ‰€æœ‰ Pod |
| `kubectl delete pod -l app=nginx` | åˆ é™¤æ‰€æœ‰ `app=nginx` çš„ Pod |

---

### **å¸¸ç”¨åœºæ™¯ç¤ºä¾‹**
#### **1. æŸ¥çœ‹æ‰€æœ‰ Pod çš„è¯¦ç»†ä¿¡æ¯**
```bash
kubectl get pod -A -o wide
```

#### **2. ç­›é€‰å¹¶æŸ¥çœ‹ç‰¹å®šæ ‡ç­¾çš„ Pod**
```bash
kubectl get pod -l app=nginx --show-labels
```

#### **3. è¿›å…¥ Pod è°ƒè¯•**
```bash
kubectl exec -it nginx-pod -- /bin/sh
```

#### **4. æŸ¥çœ‹ Pod æ—¥å¿—**
```bash
kubectl logs nginx-pod -f
```

#### **5. åˆ é™¤æ‰€æœ‰ `app=nginx` çš„ Pod**
```bash
kubectl delete pod -l app=nginx
```

---

### **æ€»ç»“**
- **`kubectl get`**ï¼šæŸ¥çœ‹èµ„æºï¼Œæ”¯æŒç­›é€‰ã€ç›‘æ§ã€æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚
- **`kubectl exec`**ï¼šè¿›å…¥ Pod è°ƒè¯•æˆ–æ‰§è¡Œå‘½ä»¤ã€‚
- **`kubectl logs`**ï¼šæŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œæ”¯æŒå®æ—¶ç›‘æ§ã€‚
- **`kubectl describe`**ï¼šæŸ¥çœ‹èµ„æºè¯¦ç»†çŠ¶æ€å’Œäº‹ä»¶ã€‚
- **`kubectl delete`**ï¼šåˆ é™¤èµ„æºï¼Œæ”¯æŒæŒ‰æ ‡ç­¾æ‰¹é‡åˆ é™¤ã€‚

è¿™äº›å‘½ä»¤è¦†ç›–äº† **80% çš„æ—¥å¸¸ Kubernetes è¿ç»´åœºæ™¯**ï¼Œç†Ÿç»ƒæŒæ¡åå¯ä»¥é«˜æ•ˆç®¡ç†é›†ç¾¤èµ„æºã€‚ğŸš€


# Podçš„ç”Ÿå‘½å‘¨æœŸ(ä»åˆ›å»ºè‡³æ­»äº¡çš„å…¨éƒ¨æµç¨‹)

![055](../img/img_55.png)

![058](../img/img_58.png)

![059](../img/img_59.png)

![060](../img/img_60.png)

å¯ä»¥æŒ‰ç…§éœ€è¦ï¼Œä¸ºä¸åŒå®¹å™¨è®¾ç½®ä¸åŒçš„é’©å­æˆ–è€…æ¢é’ˆï¼Œæ‰€æœ‰çš„æ¢æµ‹æœºåˆ¶/æ¢é’ˆä¾ç„¶æ˜¯é€šè¿‡å½“å‰èŠ‚ç‚¹çš„kubeletå»å®Œæˆæ‰§è¡Œ

## Pod ç”Ÿå‘½å‘¨æœŸ - initC - 1

![056](../img/img_56.png)

## Pod ç”Ÿå‘½å‘¨æœŸ - initC - 2

![056](../img/img_57.png)

## æ£€æµ‹initCçš„é˜»å¡æ€§

### æ–‡ä»¶: `initc.pod.yaml`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: initc-1
  labels:
    app: initc
spec:
  containers:
    - name: myapp-container
      image: busybox:1.36
      command: ['sh', '-c', 'echo The app is running! && sleep 3600']
  initContainers:
    - name: init-myservice
      image: busybox:1.36
      command: ['sh', '-c', 'until wget -q --spider --timeout=2 http://myservice; do echo "ç­‰å¾… myservice..."; sleep 2; done;']
    - name: init-mydb
      image: busybox:1.36
      command: ['sh', '-c', 'until wget -q --spider --timeout=2 http://mydb; do echo "ç­‰å¾… mydb..."; sleep 2; done;']
```

```shell
kubectl apply -f initc.pod.yaml
```


ç°åœ¨initc-1è¿™ä¸ªpodä¼šé˜»å¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºmyserviceå’Œmydbè¿™ä¸¤ä¸ªserviceï¼Œè¿™ä¸ªinitc-1æ‰å¯ä»¥åˆ›å»ºæˆåŠŸ



### æ–‡ä»¶ 1: `myservice-and-pod.yaml`ï¼ˆåˆ›å»º myservice åŠå…¶åç«¯ Podï¼‰
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  selector:
    app: myservice  
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: myservice-backend
  labels:
    app: myservice  
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
```

### æ–‡ä»¶ 2: `mydb-and-pod.yaml`ï¼ˆåˆ›å»º mydb åŠå…¶åç«¯ Podï¼‰
```yaml
apiVersion: v1
kind: Service
metadata:
  name: mydb
spec:
  selector:
    app: mydb  
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: mydb-backend
  labels:
    app: mydb  
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
```


### éƒ¨ç½²æ­¥éª¤ï¼š
1. åˆ›å»ºæœåŠ¡èµ„æºå’Œåç«¯ Podsï¼š
```bash
kubectl apply -f myservice-and-pod.yaml
kubectl apply -f mydb-and-pod.yaml
```




## Pod ç”Ÿå‘½å‘¨æœŸ - æ¢é’ˆ

![061](../img/img_61.png)


## Pod ç”Ÿå‘½å‘¨æœŸ - æ¢é’ˆåˆ†ç±»

- startupProbe: å¼€å§‹æ£€æµ‹å—ï¼Ÿ
- livenessProbe: è¿˜æ´»ç€å—ï¼Ÿ
- readinessProbe: å‡†å¤‡æä¾›æœåŠ¡äº†å—ï¼Ÿ


## Pod ç”Ÿå‘½å‘¨æœŸ - readinessProbe å°±ç»ªæ¢é’ˆ

![062](../img/img_62.png)



> å°±ç»ªæ¢æµ‹ï¼šå¦‚æœpodå†…éƒ¨çš„Cä¸æ·»åŠ å°±ç»ªæ¢æµ‹ï¼Œé»˜è®¤å°±ç»ªã€‚å¦‚æœæ·»åŠ äº†å°±ç»ªæ¢æµ‹ï¼Œåªæœ‰å°±ç»ªé€šè¿‡ä»¥åï¼Œæ‰æ ‡è®°ä¿®æ”¹ä¸ºå°±ç»ªçŠ¶æ€ã€‚å½“å‰podå†…çš„æ‰€æœ‰çš„Céƒ½å°±ç»ªï¼Œæ‰æ ‡è®°å½“å‰Podå°±ç»ª

- æˆåŠŸï¼šå°†å½“å‰çš„Cæ ‡è®°ä¸ºå°±ç»ª
- å¤±è´¥ï¼šé™é»˜
- æœªçŸ¥ï¼šé™é»˜


### å®éªŒ

#### 1.pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-1
  namespace: default
  labels:
    app: myapp
spec:
  containers:
    - name: myapp-1
      image: nginx:alpine  
```

#### 2.pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-2
  namespace: default
  labels:
    app: myapp
    version: v1
spec:
  containers:
    - name: myapp-1
      image: nginx:alpine  
```



#### åˆ›å»ºservice

```shell
kubectl create svc clusterip myapp --tcp=80:80
```

#### 3.pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-3
  namespace: default
  labels:
    app: test
    version: v1
spec:
  containers:
    - name: myapp-1
      image: nginx:alpine  
```


æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ `curl`å‘½ä»¤å»è®¿é—®æˆ‘ä»¬serviceçš„åœ°å€æ—¶ï¼Œä¼šå‘ç°åªä¼šè´Ÿè½½å‡è¡¡pod-1,pod-2,pod-3å› ä¸ºæ ‡ç­¾æ— æ³•åŒ¹é…ä¸Šï¼Œæ‰€ä»¥ä¸ä¼šè´Ÿè½½å‡è¡¡åˆ°


## å°±ç»ªæ£€æµ‹

### åŸºäº HTTP Getæ–¹å¼

#### 4.pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: readiness-httpget-pod
  namespace: default
  labels:
    app: myapp
    env: test
spec:
  containers:
    - name: readiness-httpget-container
      image: nginx:1.23  # æ›¿æ¢ä¸ºå…¬å…±é•œåƒ
      imagePullPolicy: IfNotPresent
      readinessProbe:
        httpGet:
          port: 80
          path: /index1.html  # nginx é»˜è®¤é¦–é¡µè·¯å¾„ï¼ˆåŸé…ç½®æ˜¯ /index1.htmlï¼Œè‹¥éœ€æµ‹è¯•æ¢é’ˆå¤±è´¥å¯ä¿ç•™åŸè·¯å¾„ï¼‰
        initialDelaySeconds: 1
        periodSeconds: 3
```

ç„¶åæˆ‘ä»¬æ‰§è¡Œ

```shell
kubectl apply -f 4.pod.yaml
kubectl get pod --show-labels
```

æˆ‘ä»¬ä¼šå‘ç°:
`readiness-httpget-pod   0/1     Running   0          72s   app=myapp,env=test`

```shell
kubectl describe pod readiness-httpget-pod
```

æˆ‘ä»¬ä¼šå‘ç°å°±ç»ªæ¢æµ‹å¤±è´¥:

```
Events:
  Type     Reason     Age                   From               Message
  ----     ------     ----                  ----               -------
  Normal   Scheduled  3m30s                 default-scheduler  Successfully assigned default/readiness-httpget-pod to k8s-node01
  Normal   Pulling    3m30s                 kubelet            Pulling image "nginx:1.23"
  Normal   Pulled     2m27s                 kubelet            Successfully pulled image "nginx:1.23" in 1m2.803s (1m2.803s including waiting)
  Normal   Created    2m26s                 kubelet            Created container readiness-httpget-container
  Normal   Started    2m26s                 kubelet            Started container readiness-httpget-container
  Warning  Unhealthy  90s (x21 over 2m25s)  kubelet            Readiness probe failed: HTTP probe failed with statuscode: 404

```

å¦‚æœæƒ³è®©æ¢æµ‹æˆåŠŸï¼Œæ‰§è¡Œï¼š

```shell
kubectl exec -it readiness-httpget-pod -- /bin/sh  # è¿›å…¥å®¹å™¨
# åœ¨å®¹å™¨å†…æ‰§è¡Œï¼ˆä»¥ Nginx ä¸ºä¾‹ï¼‰ï¼š
echo "Hello" > /usr/share/nginx/html/index1.html  # Nginx é»˜è®¤ç«™ç‚¹ç›®å½•
exit
```


### åŸºäº EXECæ–¹å¼


#### 5.pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: readiness-exec-pod
  namespace: default
spec:
  containers:
    - name: readiness-exec-container
      image: busybox:latest  # æ›¿æ¢ä¸ºå®˜æ–¹å…¬å¼€é•œåƒ
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c", "touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600"]
      readinessProbe:
        exec:
          command: ["test", "-e", "/tmp/live"]  # æ£€æŸ¥ /tmp/live æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        initialDelaySeconds: 1
        periodSeconds: 3
```

ç„¶åæ‰§è¡Œ:

```shell
kubectl get pod -w
```

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼š

```
NAME                    READY   STATUS    RESTARTS   AGE
readiness-exec-pod      1/1     Running   0          22s
readiness-exec-pod      0/1     Running   0          69s

```



è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ª Kubernetes **Pod**ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯é€šè¿‡ **å°±ç»ªæ¢é’ˆï¼ˆreadinessProbeï¼‰** åŠ¨æ€æ£€æµ‹å®¹å™¨æ˜¯å¦å°±ç»ªã€‚ä»¥ä¸‹æ˜¯é€éƒ¨åˆ†è§£æï¼š

---

### 1. **åŸºç¡€ä¿¡æ¯**
```yaml
apiVersion: v1  # Kubernetes API ç‰ˆæœ¬
kind: Pod       # èµ„æºç±»å‹ä¸º Pod
metadata:
  name: readiness-exec-pod   # Pod åç§°
  namespace: default         # éƒ¨ç½²åˆ° default å‘½åç©ºé—´
```
- **ä½œç”¨**ï¼šå£°æ˜ä¸€ä¸ªåä¸º `readiness-exec-pod` çš„ Podï¼Œä½¿ç”¨æœ€åŸºç¡€çš„ `v1` API ç‰ˆæœ¬ã€‚

---

### 2. **å®¹å™¨é…ç½®**
```yaml
spec:
  containers:
    - name: readiness-exec-container  # å®¹å™¨åç§°
      image: busybox:latest          # ä½¿ç”¨å®˜æ–¹ busybox é•œåƒ
      imagePullPolicy: IfNotPresent  # æœ¬åœ°æœ‰é•œåƒåˆ™ä¸æ‹‰å–
      command: ["/bin/sh", "-c", "touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600"]
```
- **å…³é”®è¡Œä¸º**ï¼š
    - **å¯åŠ¨æ—¶**ï¼šåˆ›å»ºæ–‡ä»¶ `/tmp/live`ï¼Œè¡¨ç¤ºæœåŠ¡å°±ç»ªã€‚
    - **60 ç§’å**ï¼šåˆ é™¤ `/tmp/live`ï¼Œæ¨¡æ‹ŸæœåŠ¡æ•…éšœã€‚
    - **åç»­**ï¼šç¡çœ  3600 ç§’ä¿æŒå®¹å™¨è¿è¡Œï¼ˆé¿å…é€€å‡ºï¼‰ã€‚

---

### 3. **å°±ç»ªæ¢é’ˆï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰**
```yaml
readinessProbe:
  exec:
    command: ["test", "-e", "/tmp/live"]  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  initialDelaySeconds: 1   # å®¹å™¨å¯åŠ¨å 1 ç§’å¼€å§‹æ¢æµ‹
  periodSeconds: 3         # æ¯ 3 ç§’æ£€æµ‹ä¸€æ¬¡
```
- **å·¥ä½œåŸç†**ï¼š
    1. **æ¢æµ‹æ–¹å¼**ï¼šé€šè¿‡ `exec` æ‰§è¡Œ `test -e /tmp/live` å‘½ä»¤ï¼Œè¿”å› `0`ï¼ˆæ–‡ä»¶å­˜åœ¨ï¼‰åˆ™åˆ¤å®šä¸ºå°±ç»ªã€‚
    2. **çŠ¶æ€å˜åŒ–**ï¼š
        - **å‰ 60 ç§’**ï¼šæ–‡ä»¶å­˜åœ¨ â†’ æ¢é’ˆæˆåŠŸ â†’ Pod çŠ¶æ€ä¸º `Ready`ã€‚
        - **60 ç§’å**ï¼šæ–‡ä»¶è¢«åˆ é™¤ â†’ æ¢é’ˆå¤±è´¥ â†’ Pod çŠ¶æ€ä¸º `Not Ready`ï¼ˆæµé‡ä¸å†è·¯ç”±åˆ°è¯¥ Podï¼‰ã€‚

---

### 4. **è®¾è®¡æ„å›¾**
- **æ¨¡æ‹ŸæœåŠ¡çŠ¶æ€å˜åŒ–**ï¼š
    - é€šè¿‡æ–‡ä»¶å­˜åœ¨ä¸å¦åŠ¨æ€æ§åˆ¶ Pod çš„å°±ç»ªçŠ¶æ€ï¼Œæµ‹è¯• Kubernetes çš„**æµé‡è‡ªåŠ¨åˆ‡æ¢èƒ½åŠ›**ã€‚
- **å…¸å‹åœºæ™¯**ï¼š
    - å½“å®¹å™¨å†…æœåŠ¡å´©æºƒæ—¶ï¼ˆå¦‚åˆ é™¤ `/tmp/live`ï¼‰ï¼ŒKubernetes ä¼šè‡ªåŠ¨å°† Pod æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œå¹¶ä» Service çš„è´Ÿè½½å‡è¡¡ä¸­å‰”é™¤ã€‚

---

### 5. **éªŒè¯æ–¹æ³•**
```bash
kubectl apply -f pod.yaml
kubectl get pods -w  # è§‚å¯Ÿ Pod çŠ¶æ€å˜åŒ–
```
- **é¢„æœŸè¾“å‡º**ï¼š
  ```
  NAME                  READY   STATUS    RESTARTS   AGE
  readiness-exec-pod     1/1     Running   0          10s  # åˆå§‹å°±ç»ª
  readiness-exec-pod     0/1     Running   0          61s  # 60 ç§’åæœªå°±ç»ª
  ```

---

### æ€»ç»“
è¿™æ®µé…ç½®æ˜¯ä¸€ä¸ªç»å…¸çš„**å°±ç»ªæ¢é’ˆå®éªŒ**ï¼Œé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°æœåŠ¡å¯ç”¨æ€§æ§åˆ¶ï¼š
1. **æ–‡ä»¶ä½œä¸ºå¥åº·æ ‡å¿—**ï¼š`/tmp/live` å­˜åœ¨ä¸å¦å†³å®šå°±ç»ªçŠ¶æ€ã€‚
2. **è‡ªåŠ¨æµé‡ç®¡ç†**ï¼šKubernetes æ ¹æ®æ¢é’ˆç»“æœåŠ¨æ€è°ƒæ•´ Pod çš„æµé‡æ¥æ”¶æƒé™ã€‚
3. **æ•…éšœæ¨¡æ‹Ÿ**ï¼š60 ç§’åè‡ªåŠ¨è§¦å‘â€œæ•…éšœâ€ï¼Œæµ‹è¯•é›†ç¾¤çš„è‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€‚


### åŸºäº TCP Checkæ–¹å¼(ä¸å¸¸ç”¨)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: readiness-tcp-pod  
spec:
  containers:
    - name: readiness-exec-container  
      image: nginx:1.23  
      readinessProbe:
        tcpSocket:
          port: 80  # æ£€æµ‹80ç«¯å£çš„TCPè¿æ¥æ€§
        initialDelaySeconds: 5  # å®¹å™¨å¯åŠ¨å5ç§’å¼€å§‹æ¢æµ‹
        timeoutSeconds: 1  # æ¢æµ‹è¶…æ—¶æ—¶é—´ä¸º1ç§’
```




## Pod ç”Ÿå‘½å‘¨æœŸ - livenessProbe å­˜æ´»æ¢é’ˆ

![063](../img/img_63.png)


> å­˜æ´»æ¢æµ‹ï¼šå¦‚æœPodå†…éƒ¨ä¸æŒ‡å®šå­˜æ´»æ¢æµ‹ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå®¹å™¨è¿è¡Œä½†æ˜¯æ— æ³•æä¾›æœåŠ¡çš„æƒ…å†µ

- æˆåŠŸï¼šé™é»˜
- å¤±è´¥ï¼šæ ¹æ®é‡å¯çš„ç­–ç•¥è¿›è¡Œé‡å¯çš„åŠ¨ä½œ
- æœªçŸ¥ï¼šé™é»˜


## å­˜æ´»æ£€æµ‹

### åŸºäº Execæ–¹å¼

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-exec-pod
  namespace: default
spec:
  containers:
    - name: liveness-exec-container
      image: busybox:latest  
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c", "touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600"]
      livenessProbe:
        exec:
          command: ["test", "-e", "/tmp/live"]  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        initialDelaySeconds: 1  # å®¹å™¨å¯åŠ¨1ç§’åå¼€å§‹æ¢æµ‹
        periodSeconds: 3       # æ¯3ç§’æ£€æµ‹ä¸€æ¬¡
```


è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ª Kubernetes **Pod**ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯é€šè¿‡**å­˜æ´»æ¢é’ˆï¼ˆlivenessProbeï¼‰**åŠ¨æ€æ£€æµ‹å®¹å™¨å¥åº·çŠ¶æ€ï¼Œå¹¶åœ¨å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯å®¹å™¨ã€‚ä»¥ä¸‹æ˜¯é€éƒ¨åˆ†è§£æï¼š

---

### 1. **åŸºç¡€ä¿¡æ¯**
```yaml
apiVersion: v1  # Kubernetes åŸºç¡€ API ç‰ˆæœ¬
kind: Pod       # èµ„æºç±»å‹ä¸º Pod
metadata:
  name: liveness-exec-pod    # Pod åç§°
  namespace: default         # éƒ¨ç½²åˆ°é»˜è®¤å‘½åç©ºé—´
```
- **ä½œç”¨**ï¼šå£°æ˜ä¸€ä¸ªåä¸º `liveness-exec-pod` çš„ Podï¼Œç”¨äºæ¼”ç¤ºå­˜æ´»æ¢é’ˆçš„è‡ªåŠ¨æ¢å¤æœºåˆ¶ã€‚

---

### 2. **å®¹å™¨é…ç½®**
```yaml
spec:
  containers:
    - name: liveness-exec-container  # å®¹å™¨åç§°
      image: busybox:latest         # è½»é‡çº§ Linux å·¥å…·é›†é•œåƒ
      imagePullPolicy: IfNotPresent # æœ¬åœ°æœ‰é•œåƒåˆ™ä¸æ‹‰å–
      command: ["/bin/sh", "-c", "touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600"]
```
- **å…³é”®è¡Œä¸º**ï¼š
    1. **å¯åŠ¨æ—¶**ï¼šåˆ›å»ºæ–‡ä»¶ `/tmp/live`ï¼ˆè¡¨ç¤ºæœåŠ¡å¥åº·ï¼‰ã€‚
    2. **60 ç§’å**ï¼šåˆ é™¤ `/tmp/live`ï¼ˆæ¨¡æ‹ŸæœåŠ¡å´©æºƒï¼‰ã€‚
    3. **åç»­**ï¼šç¡çœ  3600 ç§’ä¿æŒå®¹å™¨è¿è¡Œï¼ˆé¿å…ç›´æ¥é€€å‡ºï¼‰ã€‚

---

### 3. **å­˜æ´»æ¢é’ˆï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰**
```yaml
livenessProbe:
  exec:
    command: ["test", "-e", "/tmp/live"]  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  initialDelaySeconds: 1  # å®¹å™¨å¯åŠ¨å 1 ç§’å¼€å§‹æ¢æµ‹
  periodSeconds: 3        # æ¯ 3 ç§’æ£€æµ‹ä¸€æ¬¡
```
- **å·¥ä½œåŸç†**ï¼š
    - **æ¢æµ‹é€»è¾‘**ï¼šé€šè¿‡æ‰§è¡Œ `test -e /tmp/live` å‘½ä»¤æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚
        - **æ–‡ä»¶å­˜åœ¨**ï¼ˆè¿”å› `0`ï¼‰ï¼šå®¹å™¨å¥åº·ã€‚
        - **æ–‡ä»¶ä¸å­˜åœ¨**ï¼ˆè¿”å›é `0`ï¼‰ï¼šåˆ¤å®šå®¹å™¨å¼‚å¸¸ï¼Œè§¦å‘é‡å¯ã€‚
    - **å‚æ•°æ„ä¹‰**ï¼š
        - `initialDelaySeconds: 1`ï¼šé¿å…å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„è¯¯åˆ¤ã€‚
        - `periodSeconds: 3`ï¼šé«˜é¢‘æ£€æµ‹ï¼ˆç”Ÿäº§ç¯å¢ƒé€šå¸¸è®¾ä¸º 10~30 ç§’ï¼‰ã€‚

---

### 4. **è®¾è®¡æ„å›¾**
- **æ¨¡æ‹ŸæœåŠ¡å´©æºƒåœºæ™¯**ï¼š
    - 60 ç§’ååˆ é™¤æ–‡ä»¶ â†’ æ¢é’ˆå¤±è´¥ â†’ Kubernetes è‡ªåŠ¨é‡å¯å®¹å™¨ï¼ˆ`RESTARTS` è®¡æ•°å¢åŠ ï¼‰ã€‚
- **ä¸å°±ç»ªæ¢é’ˆçš„åŒºåˆ«**ï¼š
    - **å­˜æ´»æ¢é’ˆ**ï¼šå¤±è´¥æ—¶é‡å¯å®¹å™¨ï¼ˆè§£å†³æ­»é”ã€åƒµæ­»ç­‰é—®é¢˜ï¼‰ã€‚
    - **å°±ç»ªæ¢é’ˆ**ï¼šå¤±è´¥æ—¶ä»…åœæ­¢æµé‡è·¯ç”±ï¼ˆè§£å†³ä¾èµ–é¡¹æœªå°±ç»ªç­‰é—®é¢˜ï¼‰ã€‚

---

### 5. **éªŒè¯æ–¹æ³•**
```bash
# éƒ¨ç½² Pod
kubectl apply -f pod.yaml

# è§‚å¯ŸçŠ¶æ€ï¼ˆ60ç§’åå®¹å™¨ä¼šé‡å¯ï¼‰
kubectl get pods -w

# æŸ¥çœ‹é‡å¯å†å²
kubectl describe pod liveness-exec-pod | grep Restart
```
- **é¢„æœŸè¾“å‡º**ï¼š
  ```
  NAME                 READY   STATUS    RESTARTS   AGE
  liveness-exec-pod    1/1     Running   1          61s  # 60ç§’åè§¦å‘é‡å¯
  ```

---

### æ€»ç»“
è¿™æ®µé…ç½®é€šè¿‡**å­˜æ´»æ¢é’ˆ**å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
1. **è‡ªåŠ¨æ•…éšœæ¢å¤**ï¼šå½“æœåŠ¡å´©æºƒï¼ˆæ–‡ä»¶è¢«åˆ é™¤ï¼‰æ—¶ï¼Œè‡ªåŠ¨é‡å¯å®¹å™¨ã€‚
2. **è½»é‡çº§æ£€æµ‹**ï¼šåŸºäºæ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼Œæ— éœ€ä¾èµ–ç½‘ç»œæˆ–å¤æ‚å‘½ä»¤ã€‚
3. **å¿«é€Ÿå“åº”**ï¼šé«˜é¢‘æ¢æµ‹ï¼ˆ3 ç§’ï¼‰ç¡®ä¿åŠæ—¶å‘ç°é—®é¢˜ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- ç›‘æ§é•¿æ—¶é—´è¿è¡Œè¿›ç¨‹çš„å¥åº·çŠ¶æ€ï¼ˆå¦‚å®šæ—¶ä»»åŠ¡ã€åå°æœåŠ¡ï¼‰ã€‚
- å¤„ç†å†…å­˜æ³„æ¼æˆ–æ­»é”é—®é¢˜ï¼ˆé€šè¿‡é‡å¯æ¢å¤æœåŠ¡ï¼‰ã€‚


### åŸºäº HTTP Getæ–¹å¼

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-httpget-pod
  namespace: default
spec:
  containers:
    - name: liveness-httpget-container
      image: nginx:1.23  
      imagePullPolicy: IfNotPresent
      ports:
        - name: http
          containerPort: 80  # Nginx é»˜è®¤ç›‘å¬ç«¯å£
      livenessProbe:
        httpGet:
          port: 80
          path: /index.html  # Nginx é»˜è®¤é¦–é¡µè·¯å¾„
        initialDelaySeconds: 1  # å®¹å™¨å¯åŠ¨1ç§’åå¼€å§‹æ¢æµ‹
        periodSeconds: 3        # æ¯3ç§’æ£€æµ‹ä¸€æ¬¡
        timeoutSeconds: 3       # æ¢æµ‹è¶…æ—¶æ—¶é—´
```


è¿™æ˜¯ä¸€ä¸ª Kubernetes Pod é…ç½®ï¼Œä½¿ç”¨ HTTP GET å­˜æ´»æ¢é’ˆæ¥ç›‘æ§ Nginx å®¹å™¨çš„å¥åº·çŠ¶æ€ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š

### 1. åŸºç¡€é…ç½®
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-httpget-pod
  namespace: default
```
- å®šä¹‰äº†ä¸€ä¸ªåä¸º `liveness-httpget-pod` çš„ Podï¼Œéƒ¨ç½²åœ¨é»˜è®¤å‘½åç©ºé—´

### 2. å®¹å™¨é…ç½®
```yaml
spec:
  containers:
    - name: liveness-httpget-container
      image: nginx:1.23
      imagePullPolicy: IfNotPresent
      ports:
        - name: http
          containerPort: 80
```
- ä½¿ç”¨å®˜æ–¹ Nginx 1.23 é•œåƒ
- é•œåƒæ‹‰å–ç­–ç•¥ï¼šæœ¬åœ°å­˜åœ¨å°±ä¸é‡æ–°æ‹‰å–
- æš´éœ² 80 ç«¯å£ï¼Œå‘½åä¸º "http"

### 3. å­˜æ´»æ¢é’ˆé…ç½®ï¼ˆæ ¸å¿ƒï¼‰
```yaml
livenessProbe:
  httpGet:
    port: 80
    path: /index.html
  initialDelaySeconds: 1
  periodSeconds: 3
  timeoutSeconds: 3
```

#### æ¢é’ˆå·¥ä½œæœºåˆ¶ï¼š
1. **æ¢æµ‹æ–¹å¼**ï¼šé€šè¿‡ HTTP GET è¯·æ±‚ `http://å®¹å™¨IP:80/index.html`
    - è¿”å› 2xx/3xx çŠ¶æ€ç  â†’ å¥åº·
    - è¿æ¥è¶…æ—¶æˆ–è¿”å› 4xx/5xx â†’ ä¸å¥åº·

2. **æ—¶é—´å‚æ•°**ï¼š
    - `initialDelaySeconds: 1`ï¼šå®¹å™¨å¯åŠ¨åç­‰å¾…1ç§’å¼€å§‹ç¬¬ä¸€æ¬¡æ¢æµ‹
    - `periodSeconds: 3`ï¼šæ¯3ç§’æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
    - `timeoutSeconds: 3`ï¼šæ¢æµ‹è¯·æ±‚3ç§’æœªå“åº”åˆ™è§†ä¸ºå¤±è´¥

3. **å¤±è´¥å¤„ç†**ï¼š
    - è¿ç»­å¤±è´¥è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤3æ¬¡ï¼‰åï¼ŒKubernetes ä¼šé‡å¯å®¹å™¨
    - å¯é€šè¿‡ `kubectl describe pod` æŸ¥çœ‹é‡å¯æ¬¡æ•°å’Œäº‹ä»¶

### 4. å®é™…æ•ˆæœ
- å½“ Nginx æ­£å¸¸è¿è¡Œï¼ˆèƒ½å“åº”/index.htmlï¼‰æ—¶ï¼šå®¹å™¨ä¿æŒè¿è¡Œ
- å½“ Nginx å´©æºƒï¼ˆæ— æ³•å“åº”è¯·æ±‚ï¼‰æ—¶ï¼š
    1. æ¢é’ˆæ£€æµ‹å¤±è´¥
    2. Kubernetes è‡ªåŠ¨é‡å¯å®¹å™¨
    3. åœ¨ `kubectl get pods` ä¸­ä¼šçœ‹åˆ° RESTARTS è®¡æ•°å¢åŠ 

### 5. æµ‹è¯•æ–¹æ³•
```bash
# å¼ºåˆ¶ä½¿æ¢é’ˆå¤±è´¥ï¼ˆåˆ é™¤é»˜è®¤é¡µé¢ï¼‰
kubectl exec liveness-httpget-pod -- rm /usr/share/nginx/html/index.html

# è§‚å¯ŸPodçŠ¶æ€å˜åŒ–
kubectl get pods -w
```
å¤§çº¦9ç§’åï¼ˆ3æ¬¡æ¢æµ‹å¤±è´¥ï¼‰ä¼šçœ‹åˆ°å®¹å™¨é‡å¯ã€‚

è¿™ä¸ªé…ç½®éå¸¸é€‚åˆç›‘æ§ Web æœåŠ¡çš„å¯ç”¨æ€§ï¼Œç¡®ä¿æ•…éšœæ—¶èƒ½è‡ªåŠ¨æ¢å¤ã€‚


### åŸºäºTCP Checkæ–¹å¼(ä¸å¸¸ç”¨)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-tcp-pod  
spec:
  containers:
    - name: liveness-tcp-container  
      image: nginx:1.23  
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 80  # æ˜ç¡®å£°æ˜å®¹å™¨æš´éœ²çš„ç«¯å£ï¼ˆå¯é€‰ï¼‰
      livenessProbe:
        tcpSocket:
          port: 80  # æ£€æµ‹80ç«¯å£çš„TCPè¿æ¥æ€§
        initialDelaySeconds: 5  # å®¹å™¨å¯åŠ¨5ç§’åå¼€å§‹æ¢æµ‹
        timeoutSeconds: 1       # æ¢æµ‹è¶…æ—¶æ—¶é—´ä¸º1ç§’
```


## Pod ç”Ÿå‘½å‘¨æœŸ - startupProbe å¯åŠ¨æ¢é’ˆ

![064](../img/img_64.png)

> å¯åŠ¨æ¢é’ˆï¼šä¿éšœå­˜æ´»æ¢é’ˆåœ¨æ‰§è¡Œçš„æ—¶å€™ä¸ä¼šå› ä¸ºæ—¶é—´è®¾å®šé—®é¢˜å¯¼è‡´æ— é™æ­»äº¡æˆ–è€…å»¶è¿Ÿå¾ˆé•¿çš„æƒ…å†µ

- æˆåŠŸï¼šå¼€å§‹å…è®¸å­˜æ´»æ¢æµ‹ å°±ç»ªæ¢æµ‹å¼€å§‹æ‰§è¡Œ
- å¤±è´¥ï¼šé™é»˜
- æœªçŸ¥ï¼šé™é»˜


### å¼€å§‹æ¢é’ˆ

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: startupprobe-1
  namespace: default
spec:
  containers:
    - name: myapp-container
      image: nginx:1.23  
      imagePullPolicy: IfNotPresent
      ports:
        - name: http
          containerPort: 80
      readinessProbe:
        httpGet:
          port: 80
          path: /index2.html  # å»ºè®®æ”¹ä¸º/index.htmlï¼ˆNginxé»˜è®¤å­˜åœ¨ï¼‰
        initialDelaySeconds: 1
        periodSeconds: 3
      startupProbe:
        httpGet:
          path: /index1.html  # å»ºè®®æ”¹ä¸º/index.htmlï¼ˆNginxé»˜è®¤å­˜åœ¨ï¼‰
          port: 80
        failureThreshold: 30
        periodSeconds: 10
```

> åº”ç”¨ç¨‹åºå°†ä¼šæœ‰æœ€å¤š5åˆ†é’Ÿ failureThreshold * periodSeconds (30 * 10 = 300s)çš„æ—¶é—´æ¥å®Œæˆå…¶å¯åŠ¨è¿‡ç¨‹ã€‚


ç„¶åæˆ‘ä»¬æ‰§è¡Œï¼š

```shell
kubectl exec -it startupprobe-1 -- sh -c \
  "echo 'Startup Probe OK' > /usr/share/nginx/html/index1.html && \
   echo 'Readiness Probe OK' > /usr/share/nginx/html/index2.html"
```

ç„¶åæˆ‘ä»¬æ‰§è¡Œ:

```shell
kubectl get pod
```

ä¼šå‘ç°å¯åŠ¨æˆåŠŸ!


## pod ç”Ÿå‘½å‘¨æœŸ - é’©å­

![065](../img/img_65.png)

### lifecycle

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: lifecycle-exec-pod 
spec:
  containers:
    - name: lifecycle-exec-container  
      image: nginx:1.23  
      imagePullPolicy: IfNotPresent
      lifecycle:
        postStart:
          exec:
            command: ["/bin/sh", "-c", "echo postStart > /usr/share/nginx/html/message"]
        preStop:
          exec:
            command: ["/bin/sh", "-c", "echo preStop > /usr/share/nginx/html/message"]
```


éªŒè¯æ–¹æ³•ï¼š

```yaml
# éƒ¨ç½²Pod
kubectl apply -f pod.yaml

# æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼ˆpostStartåº”å·²å†™å…¥ï¼‰
kubectl exec -it lifecycle-exec-pod -- cat /usr/share/nginx/html/message

# åˆ é™¤Podæ—¶è§¦å‘preStopï¼ˆè§‚å¯Ÿæ–‡ä»¶å˜åŒ–ï¼‰
kubectl delete pod lifecycle-exec-pod
kubectl exec -it lifecycle-exec-pod -- cat /usr/share/nginx/html/message
```

> tip:æˆ‘ä»¬å…¶å®åˆ é™¤Podçš„æ—¶å€™ï¼Œå†å»æŸ¥çœ‹æ–‡ä»¶å˜åŒ–ï¼Œå…¶å®æŸ¥çœ‹ä¸åˆ°äº†ï¼Œå› ä¸ºpodéƒ½æ²¡äº†ï¼Œæ‰€ä»¥å¯èƒ½è¦å†™ä¸€ä¸ªæ­»å¾ªç¯ä¸æ–­è¯»å–è¿™æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åå¼€å¯å¦å¤–ä¸€ä¸ªç»ˆç«¯åˆ é™¤podï¼Œå°±èƒ½è¯»å–å‡ºæ¥

### åŸºäº HTTP Getæ–¹å¼

```shell
docker run -it --rm -p 1234:80 nginx:1.23
```

å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œåˆ›å»ºä¸‹é¢çš„è¿™ä¸ªpod:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: lifecycle-httpget-pod
  labels:
    name: lifecycle-httpget-pod
spec:
  containers:
    - name: lifecycle-httpget-container
      image: nginx:1.23  
      ports:
        - containerPort: 80
      lifecycle:
        postStart:
          httpGet:
            host: 192.168.120.11  # éœ€æ”¹ä¸ºå®é™…å¯è®¿é—®çš„åŸŸå/IP
            path: /index.html
            port: 1234
        preStop:
          httpGet:
            host: 192.168.120.11  # éœ€æ”¹ä¸ºå®é™…å¯è®¿é—®çš„åŸŸå/IP
            path: /index.html
            port: 1234
```

æˆ‘ä»¬å¯ä»¥å‘ç°:

```shell
192.168.120.13 - - [06/Jul/2025:06:36:50 +0000] "GET /index.html HTTP/1.1" 200 615 "-" "kube-lifecycle/1.29" "-"
```

ç„¶åæˆ‘ä»¬æ‰§è¡Œ:

```shell
kubectl delete pod lifecycle-httpget-pod
```

æˆ‘ä»¬å¯ä»¥å‘ç°:

```shell
192.168.120.13 - - [06/Jul/2025:06:37:55 +0000] "GET /index.html HTTP/1.1" 200 615 "-" "kube-lifecycle/1.29" "-"
```



## podç”Ÿå‘½å‘¨æœŸ - å…³äºpreStopçš„å»¶ä¼¸è¯é¢˜

![066](../img/img_66.png)


## podç”Ÿå‘½å‘¨æœŸ - æœ€å

![067](../img/img_67.png)

```shell
docker run --name test -p 1234:80 -d nginx:1.23
```


```yaml
apiVersion: v1
kind: Pod
metadata:
  name: lifecycle-pod
  labels:
    app: lifecycle-pod
spec:
  initContainers:
    - name: init-myservice
      image: busybox:1.36
      command: ['sh', '-c', 'until wget -q --spider --timeout=2 http://myservice; do echo "ç­‰å¾… myservice..."; sleep 2; done;']
    - name: init-mydb
      image: busybox:1.36
      command: ['sh', '-c', 'until wget -q --spider --timeout=2 http://mydb; do echo "ç­‰å¾… mydb..."; sleep 2; done;']
  containers:
    - name: busybox-container
      image: busybox:latest
      command: ["/bin/sh","-c","touch /tmp/live ; sleep 600; rm -rf /tmp/live; sleep 3600"]
      livenessProbe:
        exec:
          command: ["test","-e","/tmp/live"]
        initialDelaySeconds: 1
        periodSeconds: 3
      lifecycle:
        postStart:
          httpGet:
            host: 192.168.120.11
            path: index.html
            port: 1234
        preStop:
          httpGet:
            host: 192.168.120.11
            path: index.html
            port: 1234
    - name: myapp-container
      image: nginx:latest
      livenessProbe:
        httpGet:
          port: 80
          path: /index.html
        initialDelaySeconds: 1
        periodSeconds: 3
        timeoutSeconds: 3
      readinessProbe:
        httpGet:
          port: 80
          path: /index1.html
        initialDelaySeconds: 1
        periodSeconds: 3
```



ç°åœ¨è¿™ä¸ªpodä¼šé˜»å¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºmyserviceå’Œmydbè¿™ä¸¤ä¸ªservice



### æ–‡ä»¶ 1: `myservice-and-pod.yaml`ï¼ˆåˆ›å»º myservice åŠå…¶åç«¯ Podï¼‰
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  selector:
    app: myservice  
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: myservice-backend
  labels:
    app: myservice  
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
```

### æ–‡ä»¶ 2: `mydb-and-pod.yaml`ï¼ˆåˆ›å»º mydb åŠå…¶åç«¯ Podï¼‰
```yaml
apiVersion: v1
kind: Service
metadata:
  name: mydb
spec:
  selector:
    app: mydb  
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: mydb-backend
  labels:
    app: mydb  
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
```


### éƒ¨ç½²æ­¥éª¤ï¼š
1. åˆ›å»ºæœåŠ¡èµ„æºå’Œåç«¯ Podsï¼š
```bash
kubectl apply -f myservice-and-pod.yaml
kubectl apply -f mydb-and-pod.yaml
```

```bash
kubectl exec -it lifecycle-pod -c myapp-container -- sh -c "echo 'OK' > /usr/share/nginx/html/index1.html"
```

ç°åœ¨è¿™ä¸ªpodå°±åˆ›å»ºæˆåŠŸäº†

é€šè¿‡:
```bash
docker logs test
```

å¯ä»¥çœ‹åˆ°ï¼š

```bash
192.168.120.13 - - [06/Jul/2025:07:42:15 +0000] "GET /index.html HTTP/1.1" 200 615 "-" "kube-lifecycle/1.29" "-"
```




# Podæ˜¯å¦‚ä½•è¢«è°ƒåº¦è¿è¡Œçš„ï¼Ÿ

![068](../img/img_68.png)

æ ¹æ®æä¾›çš„å›¾åƒå†…å®¹å’ŒKubernetesï¼ˆk8sï¼‰æ¶æ„åŸç†ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„Podè¿è¡Œè°ƒåº¦æµç¨‹è§£æï¼ˆå·²è¡¥å……å…³é”®æ­¥éª¤å’Œç»„ä»¶äº¤äº’ï¼‰ï¼š

---

### **å®Œæ•´Podè°ƒåº¦è¿è¡Œæµç¨‹**
1. **é•œåƒå‡†å¤‡é˜¶æ®µ**
    - å¼€å‘è€…æ„å»ºé•œåƒ `wangyanglinux/myapp:v1.0` å¹¶æ¨é€åˆ° Docker Hubï¼ˆå›¾ä¸­æ­¥éª¤1ã€2ã€8ï¼‰ã€‚
    - èŠ‚ç‚¹ä¸Šçš„ Docker å¯éšæ—¶æ‹‰å–æ­¤é•œåƒï¼ˆ`docker pull wangyanglinux/myapp:v1.0`ï¼‰ã€‚

2. **ç”¨æˆ·å‘èµ·åˆ›å»ºè¯·æ±‚**
    - ç”¨æˆ·é€šè¿‡ `kubectl run` å‘½ä»¤åˆ›å»º Podï¼ˆå›¾ä¸­æ­¥éª¤3ï¼‰ï¼š
      ```bash
      kubectl run myapp --image=wangyanglinux/myapp:v1.0 --port=8080
      ```
    - `kubectl` å°†è¯·æ±‚è½¬æ¢ä¸º **REST API è°ƒç”¨**ï¼ˆå›¾ä¸­æ­¥éª¤4ï¼‰ï¼Œå‘é€ç»™ k8s æ§åˆ¶å¹³é¢çš„ `API Server`ã€‚

3. **æ§åˆ¶å¹³é¢å¤„ç†**
    - **API Server** æ¥æ”¶åˆ°è¯·æ±‚åï¼š
        - éªŒè¯è¯·æ±‚åˆæ³•æ€§ï¼ˆèº«ä»½è®¤è¯ã€èµ„æºé…é¢ç­‰ï¼‰ã€‚
        - å°† Pod é…ç½®ä¿¡æ¯æŒä¹…åŒ–å­˜å‚¨åˆ° `etcd`ï¼ˆå›¾ä¸­æœªå±•ç¤ºä½†å…³é”®ï¼‰ã€‚
    - **è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰** ç›‘å¬æœªè°ƒåº¦çš„ Podï¼š
        - æ ¹æ®èŠ‚ç‚¹èµ„æºã€äº²å’Œæ€§ç­‰ç­–ç•¥é€‰æ‹©åˆé€‚çš„å·¥ä½œèŠ‚ç‚¹ï¼ˆå¦‚ `k8s-node01` æˆ– `k8s-node02`ï¼‰ã€‚
        - å°†èŠ‚ç‚¹ç»‘å®šä¿¡æ¯å†™å› API Serverï¼ˆå›¾ä¸­â€œè°ƒåº¦å™¨â€éƒ¨åˆ†ï¼‰ã€‚

4. **å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œ**
    - ç›®æ ‡èŠ‚ç‚¹ï¼ˆå¦‚ `k8s-node01`ï¼‰çš„ **kubelet** ç›‘å¬åˆ°æ–°ä»»åŠ¡ï¼š
        - ä» API Server è·å– Pod é…ç½®ï¼ˆå›¾ä¸­æ­¥éª¤7ï¼‰ã€‚
        - æŒ‡ä»¤ **Docker** æ‹‰å–é•œåƒï¼ˆè‹¥æœ¬åœ°ä¸å­˜åœ¨ï¼‰å¹¶å¯åŠ¨å®¹å™¨ï¼ˆå›¾ä¸­æ­¥éª¤8ï¼‰ï¼š
          ```bash
          docker run -p 8080:8080 wangyanglinux/myapp:v1.0
          ```  
        - ç›‘æ§å®¹å™¨çŠ¶æ€ï¼Œå®šæœŸå‘ API Server æŠ¥å‘Š Pod çŠ¶æ€ã€‚

5. **ç½‘ç»œä¸æœåŠ¡å°±ç»ª**
    - å®¹å™¨å¯åŠ¨åæš´éœ²ç«¯å£ `8080`ï¼ˆé€šè¿‡ `--port=8080` æŒ‡å®šï¼‰ã€‚
    - ç”¨æˆ·å¯é€šè¿‡ `kubectl` æˆ–é›†ç¾¤å†…æœåŠ¡è®¿é—®è¯¥ Podï¼ˆå›¾ä¸­æœªå±•ç¤º Service/Ingress ä½†å±äºåç»­æµç¨‹ï¼‰ã€‚

---

### **æ ¸å¿ƒç»„ä»¶äº¤äº’æµç¨‹å›¾**
```mermaid
graph LR
A[ç”¨æˆ·] -->|kubectl run| B[API Server]
B -->|å­˜å‚¨é…ç½®| C[etcd]
B -->|é€šçŸ¥| D[Scheduler]
D -->|åˆ†é…èŠ‚ç‚¹| B
B -->|é€šçŸ¥ç›®æ ‡èŠ‚ç‚¹| E[kubelet on k8s-node01]
E -->|æ‹‰å–é•œåƒ| F[Docker on k8s-node01]
F -->|è¿è¡Œå®¹å™¨| G[Pod: myapp]
G -->|ä¸ŠæŠ¥çŠ¶æ€| E --> B
```

---

### **å…³é”®è¡¥å……è¯´æ˜**
1. **è°ƒåº¦å™¨å†³ç­–ä¾æ®**
    - èŠ‚ç‚¹èµ„æºï¼ˆCPU/Memory å‰©ä½™é‡ï¼‰ã€‚
    - æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆnodeSelectorï¼‰ã€äº²å’Œæ€§ï¼ˆaffinityï¼‰ã€‚
    - æ±¡ç‚¹å’Œå®¹å¿ï¼ˆtaints/tolerationsï¼‰ã€‚

2. **kubelet çš„æ ¸å¿ƒèŒè´£**
    - ç®¡ç† Pod ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»º/é”€æ¯ï¼‰ã€‚
    - æŒ‚è½½å­˜å‚¨å·ï¼ˆVolumesï¼‰ã€‚
    - æ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ï¼ˆLiveness/Readiness Probesï¼‰ã€‚

3. **è·¨èŠ‚ç‚¹åä½œ**
    - è‹¥ `k8s-node01` èµ„æºä¸è¶³ï¼Œè°ƒåº¦å™¨ä¼šé€‰æ‹© `k8s-node02`ï¼ˆå›¾ä¸­å±•ç¤ºå¤šèŠ‚ç‚¹ï¼‰ã€‚
    - æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ kubelet å‡ä¸ API Server ä¿æŒé•¿è¿æ¥ã€‚

4. **é•œåƒæ‹‰å–å®‰å…¨**
    - ç§æœ‰é•œåƒéœ€é…ç½® `imagePullSecrets`ï¼ˆå›¾ä¸­æœªä½“ç°ä½†ç”Ÿäº§ç¯å¢ƒå¿…å¤‡ï¼‰ã€‚

---

### **å¼‚å¸¸å¤„ç†åœºæ™¯**
- **é•œåƒæ‹‰å–å¤±è´¥**ï¼škubelet ä¸ŠæŠ¥ `ImagePullBackOff` äº‹ä»¶è‡³ API Serverã€‚
- **èŠ‚ç‚¹æ•…éšœ**ï¼šè°ƒåº¦å™¨å°† Pod é‡æ–°åˆ†é…åˆ°å¥åº·èŠ‚ç‚¹ï¼ˆç”±æ§åˆ¶å™¨è‡ªåŠ¨è§¦å‘ï¼‰ã€‚
- **èµ„æºä¸è¶³**ï¼šè°ƒåº¦å™¨æŒç»­ç­‰å¾…ç›´åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹å‡ºç°ï¼ˆPending çŠ¶æ€ï¼‰ã€‚

æ­¤æµç¨‹ä½“ç°äº† Kubernetes å£°æ˜å¼ API å’Œæ§åˆ¶å™¨æ¨¡å¼çš„æ ¸å¿ƒè®¾è®¡ï¼Œå®ç°äº†ä»ç”¨æˆ·å‘½ä»¤åˆ°å®¹å™¨è¿è¡Œçš„è‡ªåŠ¨åŒ–é—­ç¯ã€‚


### è¡¥å……ï¼šList


åœ¨ Kubernetes (k8s) ä¸­ï¼Œ`List` æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦ç”¨äºè¡¨ç¤ºå¤šä¸ªåŒç±»èµ„æºçš„é›†åˆã€‚ä»¥ä¸‹æ˜¯å…³äº `List` çš„è¯¦ç»†ä»‹ç»ï¼š

---

### **1. List çš„å®šä¹‰**
`List` æ˜¯ Kubernetes API ä¸­çš„ä¸€ç§ç‰¹æ®Šèµ„æºç±»å‹ï¼Œç”¨äºå°è£…**å¤šä¸ªåŒç±»å‹èµ„æºå¯¹è±¡**ã€‚å®ƒéµå¾ªä»¥ä¸‹ç»“æ„ï¼š
```yaml
apiVersion: v1
kind: List
metadata:
  name: example-list
items:
- apiVersion: v1
  kind: Pod
  metadata: { ... }
  spec: { ... }
- apiVersion: v1
  kind: Pod
  metadata: { ... }
  spec: { ... }
```
- **`items` å­—æ®µ**ï¼šåŒ…å«å¤šä¸ªèµ„æºå¯¹è±¡çš„æ•°ç»„ï¼Œæ‰€æœ‰å¯¹è±¡å¿…é¡»æ˜¯åŒä¸€ç±»å‹ï¼ˆå¦‚å…¨æ˜¯ `Pod` æˆ–å…¨æ˜¯ `Service`ï¼‰ã€‚

---

### **2. List çš„å¸¸è§ä½¿ç”¨åœºæ™¯**
#### **(1) æ‰¹é‡æ“ä½œèµ„æº**
é€šè¿‡ `List` å¯ä»¥ä¸€æ¬¡æ€§åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤å¤šä¸ªèµ„æºï¼š
```bash
# æ‰¹é‡åˆ›å»ºå¤šä¸ª Pod
kubectl apply -f pod-list.yaml
```

#### **(2) è·å–èµ„æºé›†åˆ**
API è¯·æ±‚è¿”å›çš„ç»“æœé€šå¸¸æ˜¯ `List` ç±»å‹ï¼š
```bash
kubectl get pods -o yaml  # è¿”å› PodList
```

#### **(3) è‡ªå®šä¹‰èµ„æºé›†åˆ**
å°†å¤šä¸ªç›¸å…³èµ„æºæ‰“åŒ…åœ¨ä¸€èµ·ç®¡ç†ï¼š
```yaml
# deployment-and-service-list.yaml
apiVersion: v1
kind: List
items:
- apiVersion: apps/v1
  kind: Deployment
  metadata: { name: nginx-deploy }
  spec: { ... }
- apiVersion: v1
  kind: Service
  metadata: { name: nginx-svc }
  spec: { ... }
```

---

### **3. Kubernetes ä¸­çš„ List ç±»å‹**
Kubernetes ä¸ºæ¯ç§èµ„æºå®šä¹‰äº†å¯¹åº”çš„ `List` ç±»å‹ï¼Œä¾‹å¦‚ï¼š
| èµ„æºç±»å‹ | å¯¹åº”çš„ List ç±»å‹ |
|----------|------------------|
| Pod      | `PodList`        |
| Service  | `ServiceList`    |
| Node     | `NodeList`       |
| ConfigMap | `ConfigMapList` |

é€šè¿‡ API è®¿é—®æ—¶ï¼Œä¼šè‡ªåŠ¨è¿”å›å¯¹åº”çš„ `List` ç±»å‹ï¼š
```bash
curl http://localhost:8080/api/v1/pods  # è¿”å› PodList
```

---

### **4. å®é™…æ“ä½œç¤ºä¾‹**
#### **(1) åˆ›å»º List èµ„æº**
```yaml
# pod-list.yaml
apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: Pod
  metadata:
    name: pod-1
  spec:
    containers:
    - name: nginx
      image: nginx
- apiVersion: v1
  kind: Pod
  metadata:
    name: pod-2
  spec:
    containers:
    - name: busybox
      image: busybox
      command: ["sleep", "3600"]
```
åº”ç”¨é…ç½®ï¼š
```bash
kubectl apply -f pod-list.yaml
```

#### **(2) æŸ¥è¯¢ List èµ„æº**
```bash
kubectl get pods  # è¿”å› PodList
kubectl get services  # è¿”å› ServiceList
```

#### **(3) åˆ é™¤ List èµ„æº**
```bash
kubectl delete -f pod-list.yaml
```

---

### **5. List ä¸å…¶ä»–æ¦‚å¿µçš„åŒºåˆ«**
| æ¦‚å¿µ          | ä½œç”¨                           | ç¤ºä¾‹                     |
|---------------|-------------------------------|--------------------------|
| **List**      | å¤šä¸ªåŒç±»èµ„æºçš„é›†åˆ             | `PodList`, `ServiceList` |
| **ConfigMap** | å­˜å‚¨é”®å€¼å¯¹é…ç½®æ•°æ®             | ç¯å¢ƒå˜é‡é…ç½®             |
| **Secret**    | å­˜å‚¨æ•æ„Ÿæ•°æ®                   | TLS è¯ä¹¦                |
| **ResourceQuota** | é™åˆ¶å‘½åç©ºé—´èµ„æºæ€»é‡       | CPU/å†…å­˜é™é¢            |

---

### **6. æ³¨æ„äº‹é¡¹**
1. **ç±»å‹ä¸€è‡´æ€§**ï¼š`List` ä¸­çš„ `items` å¿…é¡»æ˜¯åŒä¸€ç±»å‹ï¼ˆä¸èƒ½æ··åˆ `Pod` å’Œ `Service`ï¼‰ã€‚
2. **åŸå­æ€§**ï¼šå¯¹ `List` çš„æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰ä¸æ˜¯åŸå­æ€§çš„ï¼Œå¯èƒ½éƒ¨åˆ†æˆåŠŸã€‚
3. **æ€§èƒ½**ï¼šå¤§å‹ `List` å¯èƒ½å½±å“ API å“åº”é€Ÿåº¦ï¼Œå»ºè®®åˆ†é¡µæŸ¥è¯¢ï¼š
   ```bash
   kubectl get pods --chunk-size=50
   ```

---

### **7. é«˜çº§ç”¨æ³•**
#### **(1) åˆ†é¡µæŸ¥è¯¢**
é€šè¿‡ API çš„ `limit` å’Œ `continue` å­—æ®µå®ç°åˆ†é¡µï¼š
```bash
curl "http://localhost:8080/api/v1/pods?limit=50"
```

#### **(2) å­—æ®µé€‰æ‹©å™¨**
è¿‡æ»¤ `List` ä¸­çš„èµ„æºï¼š
```bash
kubectl get pods --field-selector=status.phase=Running
```

#### **(3) è‡ªå®šä¹‰åˆ—è¾“å‡º**
```bash
kubectl get pods -o custom-columns=NAME:.metadata.name,STATUS:.status.phase
```

---

é€šè¿‡ç†è§£ `List` çš„æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°ç®¡ç† Kubernetes ä¸­çš„æ‰¹é‡èµ„æºæ“ä½œã€‚